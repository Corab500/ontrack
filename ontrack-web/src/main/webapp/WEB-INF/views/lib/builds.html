<script type="text/javascript" src="${base}/js/builds.js"></script>
<link rel="stylesheet" type="text/css" href="${base}/css/builds.css" />

<script id="promotionLevelsTemplate" type="type/html">
    {{#if promotionLevels.length}}
    <ul class="promotions">
        {{#promotionLevels}}
        <li>
            <i class="icon-arrow-right"></i>
            <img width="24" src="gui/project/{{../project}}/branch/{{../branch}}/promotion_level/{{name}}/image" />
            <a class="tooltip-source" href="gui/project/{{../project}}/branch/{{../branch}}/promotion_level/{{name}}" title="{{signature.elapsedTime}} - {{signature.formattedTime}}">{{name}}</a>
        </li>
        {{/promotionLevels}}
    </ul>
    {{else}}
    <span class="muted"><@lh key="build.promotion_levels.none" /></span>
    {{/if}}
</script>

<#macro builds project branch id="builds">
	<@dynamicsection id=id template="Builds.buildTemplate('${project?html}','${branch?html}')">
	</@dynamicsection>

    <script id="branchBuildsTemplate" type="text/html">
        <table class="table">
            <thead>
                <tr>
                    <th rowspan="2">&nbsp;</th>
                    <th rowspan="2"><@lh key="model.build" /></th>
                    <th rowspan="2"><@lh key="branch.promotion_levels" /></th>
                    <th colspan="{{branchBuilds.validationStamps.length}}">
                        <@lh key="branch.validation_stamps" />
                        <#if secLogged()>
                            <a href="gui/admin/project/{{project}}/branch/{{branch}}/validation_stamp/filter">
                                <i
                                        id="validation-stamps-filter-button"
                                        class="icon-filter action action-optional {{#if branchBuilds.validationStampsFiltered}}enabled{{/if}}"
                                        title="<@lh key='validation_stamp.filter'/>{{#if branchBuilds.validationStampsFiltered}} - <@lh key='validation_stamp.filter.enabled'/>{{/if}}"></i>
                            </a>
                        </#if>
                    </th>
                </tr>
                <tr>
                    {{#branchBuilds.validationStamps}}
                        <th align="center" class="validation_stamp_header" validation_stamp="{{name}}">
                            <a href="gui/project/{{../project}}/branch/{{summary.branch.name}}/validation_stamp/{{summary.name}}">
                                <img class="tooltip-source" width="24" title="{{summary.name}}{{#summary.owner}} - {{fullName}}{{/summary.owner}}" src="gui/project/{{../project}}/branch/{{summary.branch.name}}/validation_stamp/{{summary.name}}/image" />
                            </a>
                            {{#if decorations.length}}
                                <ul class="validation-stamp-decoration">
                                    {{#decorations}}
                                        <li><img src="{{iconPath}}" title="{{title}}" class="tooltip-source" width="24" height="24" /></li>
                                    {{/decorations}}
                                </ul>
                            {{/if}}
                        </th>
                    {{/branchBuilds.validationStamps}}
                </tr>
            </thead>
            <tbody>
                {{#if branchBuilds.builds.length}}
                    {{{rowFn}}}
                {{else}}
                    <tr>
                        <td colspan="{{totalColspan}}">
                            <div class="alert alert-warning"><@lh key="branch.nobuild" /></div>
                        </td>
                    </tr>
                {{/if}}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="{{totalColspan}}">
                        <!-- Filter -->
                        <button id="filter-button" type="button" class="btn {{#filterActive}}btn-warning{{/filterActive}}" onclick="Builds.showFilter('${project?html}', '${branch?html}')"><@lh key="query" /></button>
                        <!-- Diff actions -->
                        <#list extensionDiffActions() as action>
                            <button
                                    id="diff-action-${action.extension}-${action.name}"
                                    type="button"
                                    class="btn"
                                    extension="${action.extension}"
                                    name="${action.name}"
                                    path="${action.path?html}"
                                    project="${project?html}"
                                    branch="${branch?html}"
                                    onclick="Builds.diffAction(this)"
                                    >
                                ${action.title?html}
                            </button>
                        </#list>
                    </td>
                </tr>
            </tfoot>
        </table>
    </script>

    <!-- Filter data -->
    <@dynamicsection id="filter-form-section" template="Builds.filterFormTemplate('${project?html}', '${branch?html}')" />

    <script id="filterFormTemplate" type="text/html">
        <form id="filter-form" class="hidden">
            <p>
                <@lh key="query.withPromotionLevel" />
                <select id="withPromotionLevel" name="withPromotionLevel" class="input-medium">
                    <option value="">&nbsp;</option>
                    {{#promotionLevels}}
                        <option value="{{name}}">{{name}}</option>
                    {{/promotionLevels}}
                </select>
                <@lh key="query.sincePromotionLevel" />
                <select id="sincePromotionLevel" name="sincePromotionLevel" class="input-medium">
                    <option value="">&nbsp;</option>
                    {{#promotionLevels}}
                        <option value="{{name}}">{{name}}</option>
                    {{/promotionLevels}}
                </select>
            </p>
            <p>
                <@lh key="query.withValidationStamp" />
                <select id="withValidationStamp" name="withValidationStamp" class="input-large">
                    <option value="">&nbsp;</option>
                    {{#validationStamps}}
                        <option value="{{name}}">{{name}}</option>
                    {{/validationStamps}}
                </select>
                <@lh key="query.withValidationStamp.status" />
                <select id="withValidationStampStatus" name="withValidationStampStatus" class="input-medium">
                    <option value="">&nbsp;</option>
                    {{#statuses}}
                        <option value="{{.}}">{{.}}</option>
                    {{/statuses}}
                </select>
            </p>
            <p>
                <@lh key="query.sinceValidationStamp" />
                <select id="sinceValidationStamp" name="sinceValidationStamp" class="input-large">
                    <option value="">&nbsp;</option>
                    {{#validationStamps}}
                        <option value="{{name}}">{{name}}</option>
                    {{/validationStamps}}
                </select>
                <@lh key="query.sinceValidationStamp.status" />
                <select id="sinceValidationStampStatus" name="sinceValidationStampStatus" class="input-medium">
                    <option value="">&nbsp;</option>
                    {{#statuses}}
                        <option value="{{.}}">{{.}}</option>
                    {{/statuses}}
                </select>
            </p>
            <p>
                <@lh key="query.limit" />
                <input id="limit" name="limit" type="number" class="input-mini" min="1" value="10" max="100" maxlength="3" />
            </p>
            <p>
                <button type="submit" class="btn btn-primary"><@lh key="query.submit" /></button>
                <button type="button" class="btn" onclick="Builds.clearFilter()"><@lh key="query.clear" /></button>
                <button type="button" class="btn btn-link" onclick="Builds.closeFilter()"><@lh key="general.close" /></button>
            </p>
        </form>
    </script>

    <script id="branchBuildsRowTemplate" type="text/html">
        {{#branchBuilds.builds}}
            <tr>
                <td build="{{name}}" style="width:4em;">
                    <input type="radio" name="buildFrom" value="{{name}}" />
                    <input type="radio" name="buildTo" value="{{name}}" />
                </td>
                <td class="branch-build build_header" build="{{name}}">
                    <a
                            class="tooltip-source"
                            href="gui/project/{{../project}}/branch/{{../branch}}/build/{{name}}"
                            title="{{description}} - {{signature.elapsedTime}} - {{formattedTime}}">
                        {{name}}
                    </a>
                    <!-- Build decorations -->
                    {{#decorations}}
                        <span class="decoration label label-{{cls}} decoration-{{cls}} {{cls}}">{{title}}</span>
                    {{/decorations}}
                </td>
                <td class="build_promotion_level" build="{{name}}">
                    {{{promotionLevelsFn}}}
                </td>
                {{#../branchBuilds.validationStamps}}
                    <td class="build_validation_stamp" build="{{../name}}" validation_stamp="{{summary.name}}">
                        {{{compactValidationStampFn ../name this}}}
                    </td>
                {{/../branchBuilds.validationStamps}}
            </tr>
        {{/branchBuilds.builds}}
    </script>

    <script id="compactValidationStampTemplate" type="text/html">
        {{#if buildValidationStamp.run}}
            {{#lastRun}}
                <a
                        class="tooltip-source"
                        href="gui/project/{{../../project}}/branch/{{../../branch}}/build/{{../../build}}/validation_stamp/{{../../buildValidationStamp/name}}/validation_run/{{runOrder}}"
                        title="<div style='text-align:left;'>{{#events}}- {{status}} {{content}}<br/>{{/events}}{{signature.elapsedTime}} - {{signature.formattedTime}}</div>"
                        data-html="true">
                    <img width="24" src="static/images/status-{{status}}.png" />
                </a>
            {{/lastRun}}
        {{else}}
            <img class="tooltip-source" width="24" height="24" src="static/images/status-NONE.png" title="<@lh key='validationRun.notRun'/>" />
        {{/if}}
    </script>

</#macro>
